<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF RAG with Gemini (Multilingual)</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(to right, #1e3a8a, #2563eb);
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    main {
      max-width: 960px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    h1, h2 {
      margin-top: 0;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .row {
      display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;
    }
    .row > * { flex: 1; min-width: 220px; }
    label { font-weight: 600; display: block; margin-bottom: .25rem; }
    input[type="text"], input[type="number"], input[type="file"], textarea {
      width: 100%; padding: .6rem .7rem; border: 1px solid #d1d5db; border-radius: .5rem;
    }
    button {
      padding: .6rem 1.2rem;
      border: 0;
      border-radius: .5rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
    }
    button:hover {
      background: #1d4ed8;
    }
    .muted { color:#6b7280; font-size:.9rem }
    .sources { margin-top: .75rem; }
    .source-pill {
      display:inline-block;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:.25rem .6rem;
      margin:.2rem .3rem 0 0;
      font-size:.85rem;
      background:#f3f4f6;
    }
    .spinner { display:none; }
    .show { display:inline-block; }
    pre { white-space: pre-wrap; }
    .answer-card {
      background:#f9fafb;
      border-left: 4px solid #2563eb;
      padding:1rem;
      border-radius:.5rem;
      margin-bottom:1rem;
    }
    .answer-lang {
      font-size:.9rem;
      color:#374151;
      font-weight:600;
      margin-bottom:.3rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìÑ PDF RAG with Gemini</h1>
    <p>Upload PDFs and ask questions in any language (Arabic, Spanish, English, etc.)</p>
  </header>
  <main>

    <!-- Ingest PDF -->
    <section class="card">
      <h2>1) Ingest a PDF</h2>
      <form id="ingest-form">
        <div class="row">
          <div>
            <label for="pdf">PDF file</label>
            <input id="pdf" name="file" type="file" accept="application/pdf" required />
          </div>
          <div>
            <label for="title">Document title (optional)</label>
            <input id="title" name="title" type="text" placeholder="e.g., Employee Handbook" />
          </div>
        </div>
        <div class="row" style="margin-top:.75rem;">
          <button type="submit">Upload & Index</button>
          <span id="ingest-status" class="muted"></span>
          <span id="ingest-spinner" class="spinner">‚è≥</span>
        </div>
      </form>
    </section>

    <!-- Ask a question -->
    <section class="card">
      <h2>2) Ask a Question</h2>
      <form id="ask-form">
        <div class="row">
          <div style="flex:3">
            <label for="question">Question</label>
            <input id="question" type="text" placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ£Ÿà English" required />
          </div>
          <div style="flex:1; max-width:120px">
            <label for="k">Top-K</label>
            <input id="k" type="number" min="1" max="10" value="4" />
          </div>
        </div>
        <div class="row" style="margin-top:.75rem;">
          <button type="submit">Ask</button>
          <span id="ask-spinner" class="spinner">‚è≥</span>
        </div>
      </form>

      <div id="answer-box" style="margin-top:1rem; display:none;">
        <h3>Answer</h3>
        <div id="answer-original" class="answer-card">
          <div class="answer-lang">üåç Original</div>
          <pre id="answer"></pre>
        </div>
        <div id="answer-english" class="answer-card" style="display:none;">
          <div class="answer-lang">üá¨üáß English Translation</div>
          <pre id="answer-en"></pre>
        </div>
        <div id="sources" class="sources"></div>
      </div>
    </section>

    <p class="muted" style="margin-top:2rem">
      ‚ö° Tip: Upload PDF ‚Üí Ask questions in any language ‚Üí Get answers + English translation.
    </p>
  </main>

  <script type="module">
    const ingestForm = document.getElementById('ingest-form');
    const askForm = document.getElementById('ask-form');

    const ingestStatus = document.getElementById('ingest-status');
    const ingestSpinner = document.getElementById('ingest-spinner');
    const askSpinner = document.getElementById('ask-spinner');

    const answerBox = document.getElementById('answer-box');
    const answerEl = document.getElementById('answer');
    const answerEnBox = document.getElementById('answer-english');
    const answerEnEl = document.getElementById('answer-en');
    const sourcesEl = document.getElementById('sources');

    function setSpinner(el, on) { el.classList.toggle('show', !!on); }

    // --- Upload & index PDF ---
    ingestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      ingestStatus.textContent = '';
      setSpinner(ingestSpinner, true);

      const fileInput = document.getElementById('pdf');
      const titleInput = document.getElementById('title');
      const file = fileInput.files?.[0];
      if (!file) {
        setSpinner(ingestSpinner, false);
        ingestStatus.textContent = 'Please choose a PDF.';
        return;
      }

      try {
        const form = new FormData();
        form.append('file', file);
        if (titleInput.value.trim()) form.append('title', titleInput.value.trim());

        const res = await fetch('/api/ingest_pdf', { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Upload failed');
        ingestStatus.textContent = `‚úÖ Indexed ${data.chunks} chunks from ${data.file}.`;
      } catch (err) {
        ingestStatus.textContent = '‚ùå Error: ' + (err?.message || String(err));
      } finally {
        setSpinner(ingestSpinner, false);
      }
    });

    // --- Ask a question ---
    askForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      answerBox.style.display = 'none';
      answerEl.textContent = '';
      answerEnEl.textContent = '';
      sourcesEl.innerHTML = '';
      setSpinner(askSpinner, true);

      const question = document.getElementById('question').value.trim();
      const k = Number(document.getElementById('k').value) || 4;

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, k })
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Request failed');

        answerBox.style.display = 'block';
        answerEl.textContent = data.answer || '(No answer returned)';
        if (data.answer_english) {
          answerEnBox.style.display = 'block';
          answerEnEl.textContent = data.answer_english;
        } else {
          answerEnBox.style.display = 'none';
        }

        if (Array.isArray(data.sources)) {
          for (const s of data.sources) {
            const pill = document.createElement('span');
            const title = s.title || s.source || 'PDF';
            const page = s.page ? `p.${s.page}` : '';
            pill.className = 'source-pill';
            pill.textContent = `${title}${page ? ' ‚Ä¢ ' + page : ''}`;
            sourcesEl.appendChild(pill);
          }
        }
      } catch (err) {
        answerBox.style.display = 'block';
        answerEl.textContent = '‚ùå Error: ' + (err?.message || String(err));
        answerEnBox.style.display = 'none';
      } finally {
        setSpinner(askSpinner, false);
      }
    });
  </script>
</body>
</html>
